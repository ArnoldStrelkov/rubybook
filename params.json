{
  "name": "Rubybook",
  "tagline": "",
  "body": "### Изучаем ROR и JS на интересном проекте\r\n\r\nМы будем делать сервис по поиску единомышленников. Это сайт на котором каждый пользователь может разместить свою идею, предложение, проект, а другие пользователи сайта могут к данному проекту присоедениться.\r\n\r\n### Проверка залогинившегося юзера\r\n\r\nПеред выполнением любого метода в контроллерах с помощью вызова `before_action :check_login` мы вызываем метод `check_login`\r\n\r\n```ruby\r\nclass ApplicationController < ActionController::Base\r\n  # Prevent CSRF attacks by raising an exception.\r\n  # For APIs, you may want to use :null_session instead.\r\n  protect_from_forgery with: :exception\r\n  before_action :check_login\r\n  \r\n  private\r\n  \r\n  def check_login\r\n   \r\n    @current_user ||= User.where(id: session[:user_id]).first\r\n    \r\n  end  \r\n  \r\nend\r\n```\r\nМетод `check_login` проверяет есть ли в куках запись сеcсии с номером `id` пользователя и если есть то находит этого юзера и записывает его в переменную `@current_user`. Данная переменная будет доступна в наших контроллерах и вьюхах. \r\n\r\n### Вывод списка идей\r\n\r\nПо умолчанию у нас стоит роут `root 'main#index'` котрый передает управление методу `index` в контроллере `main`\r\n\r\n```ruby\r\nclass MainController < ApplicationController\r\n  def index\r\n    @ideas = Idea.all.order(id: :desc)\r\n  end\r\nend\r\n```\r\n\r\nДанный метод просто запрашивает все записи из модели `Idea` в переменную `@ideas`. Затем управление передается во выюху `index.html.erb`\r\n\r\n\r\n### Вьюха index.html.erb\r\n\r\nПервый блок вьюхи это отображение меню\r\n\r\n```ruby\r\n<div class=\"menu\">\r\n    <div class=\"wrapper\"  >\r\n      <div class=\"cf\">\r\n            <div class=\"menu_text\">Поиск единомышленников </div>\r\n            <div class=\"menu_button\">\r\n                <% if @current_user%>\r\n                <%= @current_user.name %>\r\n                 <% else %>\r\n                <a  class=\"a_button\" href='/auth/vkontakte'>Войти через вк</a></div>\r\n            <% end %>\r\n         </div>  \r\n    </div>\r\n</div>   \r\n```\r\n\r\nЗдесь мы проверяем наличие `@current_user` и если он есть то выводим его имя, а если нет, то выводим кнопку входа через вконтакте.\r\n\r\n\r\nЗатем идет блок с кнопкой добавить идею. Данна конпка отображается только если юзер залогинился.\r\nПри нажатии на эту кнопку с помоштю JQuery отображается форма идеи а сама кнопка скрывается\r\n\r\n```erb\r\n<div class=\"add_idea\">\r\n    <div class=\"wrapper\">\r\n        <%if @current_user%>\r\n        <div id=\"add_idea_button\">\r\n            добавить идею\r\n        </div><%end %>\r\n        <div id=\"add_idea_form\">\r\n            <form action=\"/api/new_idea\" class=\"ajax_form idea-form\" id=\"idea-form\" method=\"post\"\r\n            name=\"idea-form\">\r\n                <div class=\"form_wrapper\">\r\n                    <label>Заголовок</label>\r\n                    <input class=\"form-control\" name=\"header\" placeholder=\"\" type=\"text\">\r\n                    <label>Текст</label> \r\n                    <textarea class=\"form-control\" name=\"body\" rows=\"10\"></textarea>\r\n                    <input name= \"authenticity_token\" type=\"hidden\" \r\n                    value=\"<%= form_authenticity_token %>\">\r\n                    <label>Видео</label> \r\n                    <input class=\"form-control\" name=\"video\" placeholder=\r\n                    \"например: https://www.youtube.com/watch?v=maX7jD6vGio\" type=\"text\">\r\n                </div>\r\n                <div id=\"add_post_button\">\r\n                    Отправить\r\n                </div>\r\n            </form>\r\n        </div>\r\n    </div>\r\n</div>   \r\n```\r\n\r\nВот код JS, ответственный за отображение формы ввода идеи при нажатии на кнопку 'добавить идею'\r\n\r\n```javascript\r\n $('#add_idea_button').on('click', function(){\r\n        $(this).hide(200);\r\n        $('#add_idea_form').show(200);\r\n        \r\n    });\r\n```\r\nДанный код отправляет форму \r\n\r\n```javascript\r\n    $('#add_post_button').on('click', function(){\r\n        $(\"#idea-form\").submit();\r\n    });\r\n```\r\nОбратите внимание на кнопку `#add_post_button` я не стал использовать тег кнопки `<button>`, вместо этого я стилизовал под кнопку обычный `<div>` и назначил клику на этот div событие - отправку формы. Сделал я это для того чтобы было легче прописывать стили, так как у кнопки уже есть некоторое отображение по умолчанию и его пришлось бы переопределять. \r\n\r\nНу и наконец, последняя часть кода, которая выводит список идей из переменной `@ideas`\r\n\r\n```erb\r\n<div class=\"idea\">\r\n    <div class=\"wrapper\">\r\n        <% for idea in @ideas %>\r\n        <div class=\"one_idea\">\r\n            <h2><%= idea.header%></h2>\r\n                <%if !idea.video.to_s.empty? %>\r\n                <div class=\"youtube\" id=\"<%= idea.video.split('?v=')[1] %>\">\r\n                    <%= image_tag \"yt.png\", class: \"yt\" %>\r\n                </div>\r\n                <% end %>\r\n                \r\n            <p><%= idea.body %></p>\r\n            \r\n            <div class=\"join_status cf\">\r\n                <div class=\"joined\">\r\n                    <% count = FollowIdea.where(idea_id: idea).count %>\r\n                    <% unless count == 0 %>\r\n                        <a class=\"a_joined\" href=\"\">присоеденилось:\r\n                    <%= count %></a> \r\n                    <% end %>\r\n                </div>\r\n                <div class=\"join\">\r\n                    <% if FollowIdea.where(user_id: @current_user, idea_id: idea).empty? %>\r\n                        <a class=\"a_join\" href='/auth/vkontakte'>присоедениться</a> \r\n                    <% else %> \r\n                        вы присоеденились\r\n                    <% end %>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"sususers\">\r\n                <% idea.users.each.with_index do |user, index| %> \r\n                <a class=\"\" href=\"https://vk.com/id<%=user.uid%>\"><%= user.name%></a><span>, </span>\r\n                <% end %>\r\n            </div>\r\n        </div>\r\n        <% end %>\r\n    </div>\r\n</div>\r\n```\r\n\r\nДавайте разберем этот код по кусочкам. Вот это цикл `for in` с помощью котрого мы перебираем все идеи которые находятся в переменной `@ideas`\r\n\r\n```erb\r\n<div class=\"idea\">\r\n    <div class=\"wrapper\">\r\n        <% for idea in @ideas %>\r\n        <div class=\"one_idea\">\r\n\t\t\r\n\t\t\t...\r\n\t\t\r\n\t\t</div>\r\n        <% end %>\r\n    </div>\r\n</div>\r\n```\r\nвыводим заголовок идеи\r\n\r\n```erb\r\n<h2><%= idea.header%></h2>\r\n```\r\nЕсли к идеи было прикреплено видео, то выводим это видео\r\n\r\n```erb\r\n<%if !idea.video.to_s.empty? %>\r\n     <div class=\"youtube\" id=\"<%= idea.video.split('?v=')[1] %>\">\r\n         <%= image_tag \"yt.png\", class: \"yt\" %>\r\n     </div>\r\n<% end %>\r\n```\r\nэта строчка просто выводит иконку ютуб по центру видео\r\n\r\n```erb\r\n\t<%= image_tag \"yt.png\", class: \"yt\" %>\r\n```\r\n\r\nА вот здесь здесь мы прописываем в id дива адрес видео с ютуба. \r\n\r\n```erb\r\n<div class=\"youtube\" id=\"<%= idea.video.split('?v=')[1] %>\">\r\n```\r\n\r\nДальнейшая обработка данного дива проходит с помошью вот такого кода JS\r\n\r\n```javascript\r\nvar youtube = function() {\r\n\r\n\t$(\".youtube\").each(function() {\r\n\r\n\t\t// определение миниатюры\r\n\t\t$(this).css('background-image', 'url(http://i.ytimg.com/vi/' + this.id + '/sddefault.jpg)');\r\n\r\n\t\t$(document).delegate('#' + this.id, 'click', function() {\r\n\t\t\t// формируем ссылку со включенной опцией autoplay\r\n\t\t\tvar iframe_url = \"https://www.youtube.com/embed/\" + this.id + \"?autoplay=1&autohide=1&rel=0\";\r\n\t\t\t\r\n\t\t\t// Формируем элемент iframe\r\n\t\t\tvar iframe = $('<iframe/>', {'frameborder': '0', 'src': iframe_url});\r\n\r\n\t\t\t// Замена миниатюры плеером\r\n\t\t\t$(this).replaceWith(iframe);\r\n\t\t});\r\n\t});\r\n\r\n}; \r\n\r\nyoutube();\r\n```\r\nВыводим текст идеи\r\n\r\n```erb\r\n<p><%= idea.body %></p>\r\n```\r\n\r\nВыводим число присоеденившихся и кнопку \"присоедениться\"\r\n\r\n```erb            \r\n<div class=\"join_status cf\">\r\n\t<div class=\"joined\">\r\n\t\t<% count = FollowIdea.where(idea_id: idea).count %>\r\n\t\t<% unless count == 0 %>\r\n\t\t\t<a class=\"a_joined\" href=\"\">присоеденилось:\r\n\t\t<%= count %></a> \r\n\t\t<% end %>\r\n\t</div>\r\n\t<div class=\"join\">\r\n\t\t<% if FollowIdea.where(user_id: @current_user, idea_id: idea).empty? %>\r\n\t\t\t<% if  @current_user%>\r\n\t\t\t\t<a class=\"a_join\" href='/susc/<%= idea.id %>'>присоедениться</a> \r\n\t\t\t<% else %>\r\n\t\t\t\t<a class=\"a_join\" href='/auth/vkontakte'>присоедениться</a>\r\n\t\t\t<% end %>\r\n\t\t\t\r\n\t\t<% else %> \r\n\t\t\tвы присоеденились\r\n\t\t<% end %>\r\n\t</div>\r\n</div>\r\n```\r\n\r\nВыводим перечень присоеденившихся\r\n\r\n```erb \r\n<div class=\"sususers\">\r\n\t\t<% idea.users.each.with_index do |user, index| %> \r\n\t\t<a class=\"\" href=\"https://vk.com/id<%=user.uid%>\"><%= user.name%></a><span>, </span>\r\n\t\t<% end %>\r\n</div>\r\n```\r\n\r\nПо умолчанию перечень присоеденившисхся находися в див со свойством `display:none;` и не отображается. Показ данного дива включается при клике на ссылку с классом a_joined с помощью такого скрипта\r\n\r\n\r\n```javascript\r\n$('.a_joined').on('click', function(e) {\r\n\te.preventDefault();\r\n\t$(this).parent().parent().parent().find('.sususers').show(200);\r\n\r\n});\r\n```\r\n\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}